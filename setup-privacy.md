# プライバシー設定セットアップガイド

このガイドでは、予約・顧客管理システムを他人に見えないようにするための設定手順を説明します。

## 1. データベースのプライバシー設定を有効化

### Supabaseダッシュボードで以下のSQLを実行してください：

```sql
-- enable-rls-security.sql の内容を実行
```

または、SQLファイルを直接実行：

```bash
# Supabase CLIを使用する場合
supabase db reset --linked
```

## 2. 管理者アカウントを作成

管理者としてアクセスできるユーザーを `admins` テーブルに追加する必要があります：

```sql
-- 管理者を追加（例：admin@studio.com）
INSERT INTO admins (email, password, name, role) VALUES 
('admin@studio.com', 'your-password-hash', 'システム管理者', 'admin');

-- スタッフを追加（必要に応じて）
INSERT INTO admins (email, password, name, role) VALUES 
('staff@studio.com', 'your-password-hash', 'スタッフ', 'staff');
```

## 3. 設定が有効になった後の動作

### ✅ 保護されるデータ
- **顧客情報** (`customers` テーブル)
- **予約情報** (`reservations` テーブル)
- **待機リスト** (`waiting_list` テーブル)
- **通知ログ** (`notification_logs` テーブル)
- **管理者情報** (`admins` テーブル)
- **アプリ設定** (`app_settings` テーブル)

### ✅ 公開されるデータ（一般ユーザーが見ることができる）
- **プログラム情報** (`programs` テーブル)
- **インストラクター情報** (`instructors` テーブル)
- **スタジオ情報** (`studios` テーブル)
- **スケジュール情報** (`schedules` テーブル)

### ✅ アクセス制御
- **管理者** (`admin` ロール): 全てのデータにアクセス可能
- **スタッフ** (`staff` ロール): 管理ダッシュボードにアクセス可能
- **一般ユーザー**: 自分の予約データのみアクセス可能
- **未認証ユーザー**: 公開データのみアクセス可能

## 4. 確認方法

### セキュリティが正しく設定されているか確認：

1. **Supabaseダッシュボード** → **Authentication** → **Policies**
2. 各テーブルでRLSが有効になっていることを確認
3. 適切なポリシーが設定されていることを確認

### フロントエンドでの確認：

1. **未認証状態**で `/dashboard` にアクセス → サインインページにリダイレクト
2. **一般ユーザー**でサインイン → 権限なしページにリダイレクト
3. **管理者**でサインイン → ダッシュボードにアクセス可能

## 5. トラブルシューティング

### 問題: 管理者でもダッシュボードにアクセスできない
**解決方法**: 
- `admins` テーブルにメールアドレスとロールが正しく設定されているか確認
- Supabaseの認証メールとデータベースのメールが一致しているか確認

### 問題: RLSポリシーが機能しない
**解決方法**:
- `enable-rls-security.sql` が正しく実行されているか確認
- Supabaseダッシュボードでポリシーが有効になっているか確認

### 問題: 一般ユーザーがデータにアクセスできない
**解決方法**:
- `customers` テーブルの `line_id` が正しく設定されているか確認
- ユーザーの認証状態が正しいか確認

## 6. 次のステップ

### さらなるセキュリティ強化のために：

1. **セッションタイムアウト**の設定
2. **二要素認証**の実装
3. **監査ログ**の実装
4. **データベースレベルでの暗号化**

### 運用上の注意事項：

- 定期的な管理者パスワード変更
- 不要な管理者アカウントの削除
- ログの定期的な確認
- バックアップの暗号化

---

## セキュリティ設定完了後の状態

✅ **顧客データ**: 本人のみアクセス可能  
✅ **予約情報**: 本人のみアクセス可能  
✅ **管理機能**: 管理者のみアクセス可能  
✅ **公開情報**: 誰でも閲覧可能（スケジュール等）  

この設定により、予約・顧客管理システムは適切にプライバシーが保護され、他人に見えないようになります。